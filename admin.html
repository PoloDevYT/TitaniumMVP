<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titanium Admin | Painel de Controle</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="toast.css">
</head>

<body>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2>TITANIUM <span style="color: var(--admin-accent);">ADMIN</span></h2>

            <nav>
                <div class="admin-nav-item active" data-view="dashboard">
                    <i data-lucide="layout-dashboard"></i> <span>Dashboard</span>
                </div>
                <div class="admin-nav-item" data-view="users">
                    <i data-lucide="users"></i> <span>Usu√°rios</span>
                </div>
                <div class="admin-nav-item" data-view="finance">
                    <i data-lucide="trending-up"></i> <span>Financeiro</span>
                </div>
                <div class="admin-nav-item" data-view="settings">
                    <i data-lucide="settings"></i> <span>Configura√ß√µes</span>
                </div>
            </nav>

            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--admin-border);">
                <div class="admin-nav-item" id="admin-logout">
                    <i data-lucide="log-out"></i> <span>Sair</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="admin-header">
                <div>
                    <h1 id="page-title">DASHBOARD</h1>
                    <p>Painel de Controle Administrativo</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div
                        style="width: 38px; height: 38px; background: linear-gradient(135deg, var(--admin-accent), #ff6b6b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1rem;">
                        A</div>
                    <div>
                        <span style="color: var(--admin-text); font-weight: 600;">Administrador</span>
                        <span class="admin-badge">GOD</span>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard">
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 35px;">
                    <div class="stat-box">
                        <i data-lucide="users" style="color: var(--admin-gold);"></i>
                        <h3 id="total-users">0</h3>
                        <span>Total Usu√°rios</span>
                    </div>
                    <div class="stat-box">
                        <i data-lucide="crown" style="color: var(--admin-accent);"></i>
                        <h3 id="total-black">0</h3>
                        <span>Membros Black</span>
                    </div>
                    <div class="stat-box">
                        <i data-lucide="shield" style="color: #888;"></i>
                        <h3 id="total-iron">0</h3>
                        <span>Membros Iron</span>
                    </div>
                </div>

                <div class="admin-card">
                    <h3><i data-lucide="activity"
                            style="width:18px; height:18px; vertical-align: middle; margin-right: 8px;"></i>Auditoria do
                        Sistema</h3>
                    <div id="logs-container" style="max-height: 350px; overflow-y: auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Executor</th>
                                    <th>A√ß√£o</th>
                                    <th>Detalhes</th>
                                    <th>Data/Hora</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body">
                                <tr>
                                    <td colspan="4" style="text-align:center; color:#555;">Nenhum log ainda</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- USERS VIEW -->
            <div id="view-users" class="hidden">
                <div class="admin-card">
                    <h3><i data-lucide="users"
                            style="width:18px; height:18px; vertical-align: middle; margin-right: 8px;"></i>Gerenciamento
                        de Membros</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Plano</th>
                                <th>Role</th>
                                <th style="text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr>
                                <td colspan="5" style="text-align:center;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ANALYTICS VIEW (Real Data Only) -->
            <div id="view-finance" class="hidden">
                <div class="admin-card">
                    <h3><i data-lucide="pie-chart"
                            style="width:18px; height:18px; vertical-align: middle; margin-right: 8px;"></i>Distribui√ß√£o
                        de Planos</h3>
                    <div id="plan-distribution" style="margin-top: 20px; line-height: 2.5;"></div>
                </div>

                <div class="admin-card" style="margin-top: 20px;">
                    <h3><i data-lucide="calendar"
                            style="width:18px; height:18px; vertical-align: middle; margin-right: 8px;"></i>√öltimos
                        Cadastros</h3>
                    <div id="recent-registrations" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="hidden">
                <div class="admin-card" style="max-width: 600px;">
                    <h3><i data-lucide="sliders"
                            style="width:18px; height:18px; vertical-align: middle; margin-right: 8px;"></i>Configura√ß√µes
                        Globais</h3>

                    <div class="admin-form-group">
                        <label>Modo Manuten√ß√£o</label>
                        <select id="setting-maintenance" class="admin-select">
                            <option value="false">üü¢ Desativado (Sistema Online)</option>
                            <option value="true">üî¥ Ativado (Apenas Admins)</option>
                        </select>
                    </div>

                    <div class="admin-form-group">
                        <label>An√∫ncio Global (Dashboard)</label>
                        <input type="text" id="setting-announcement" class="admin-input"
                            placeholder="Ex: Manuten√ß√£o programada para √†s 22h...">
                    </div>

                    <button id="save-settings-btn" class="action-btn btn-promote"
                        style="padding: 12px 25px; font-size: 0.95rem; margin-top: 10px;">
                        <i data-lucide="save"
                            style="width:16px; height:16px; vertical-align: middle; margin-right: 6px;"></i>Salvar
                        Altera√ß√µes
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const token = localStorage.getItem('titanium_token');
            if (!token) window.location.href = '/login';

            // NAVIGATION
            const views = {
                'dashboard': document.getElementById('view-dashboard'),
                'users': document.getElementById('view-users'),
                'finance': document.getElementById('view-finance'),
                'settings': document.getElementById('view-settings')
            };

            document.querySelectorAll('.admin-nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.admin-nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    const viewName = item.getAttribute('data-view');
                    document.getElementById('page-title').innerText = item.innerText.trim().toUpperCase();

                    Object.values(views).forEach(v => v.classList.add('hidden'));
                    views[viewName].classList.remove('hidden');

                    if (viewName === 'users') loadUsers();
                    if (viewName === 'finance') loadAnalytics();
                    if (viewName === 'settings') loadSettings();
                    if (viewName === 'dashboard') loadLogs(); // Reload logs on dash
                });
            });

            document.getElementById('admin-logout').addEventListener('click', () => {
                localStorage.removeItem('titanium_token');
                window.location.href = '/login';
            });

            // LOAD STATS & LOGS
            async function loadStats() {
                try {
                    const res = await fetch('/api/admin/stats', { headers: { 'x-access-token': token } });
                    const data = await res.json();
                    document.getElementById('total-users').innerText = data.totalUsers;
                    document.getElementById('total-black').innerText = data.blackUsers;
                    document.getElementById('total-iron').innerText = data.ironUsers;
                } catch (e) { console.error(e); }
            }

            async function loadLogs() {
                const tbody = document.getElementById('logs-table-body');
                try {
                    const res = await fetch('/api/admin/logs', { headers: { 'x-access-token': token } });
                    const logs = await res.json();
                    tbody.innerHTML = '';
                    logs.forEach(l => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span style="color: var(--accent-color);">${l.user_name || 'Sistema'}</span></td>
                            <td>${l.action}</td>
                            <td>${l.details}</td>
                            <td style="color:#666; font-size:0.8rem;">${new Date(l.created_at).toLocaleString()}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            // LOAD USERS & DELETE
            async function loadUsers() {
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Carregando...</td></tr>';

                try {
                    const res = await fetch('/api/admin/users', { headers: { 'x-access-token': token } });
                    const users = await res.json();

                    tbody.innerHTML = '';
                    users.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td><span class="status-badge ${u.plan === 'black' ? 'status-black' : 'status-free'}">${u.plan}</span></td>
                            <td>${u.role}</td>
                            <td>
                                <button onclick="changePlan(${u.id}, 'black')" class="action-btn btn-promote" title="Promover">‚ñ≤</button>
                                <button onclick="changePlan(${u.id}, 'free')" class="action-btn btn-demote" title="Rebaixar">‚ñº</button>
                                <button onclick="deleteUser(${u.id})" class="action-btn" style="background:#c0392b; color:#fff;" title="Excluir">‚úñ</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (e) { console.error(e); }
            }

            // LOAD ANALYTICS (Real Data Only)
            async function loadAnalytics() {
                try {
                    const res = await fetch('/api/admin/analytics', { headers: { 'x-access-token': token } });
                    const data = await res.json();

                    // Plan Distribution
                    const distDiv = document.getElementById('plan-distribution');
                    let distHtml = '';
                    data.planDistribution.forEach(p => {
                        const planLabel = p.plan === 'black' ? 'üî• BLACK' : p.plan === 'iron' ? '‚öîÔ∏è IRON' : 'üë§ FREE';
                        const color = p.plan === 'black' ? 'var(--admin-accent)' : p.plan === 'iron' ? 'var(--admin-gold)' : '#888';
                        distHtml += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--admin-border);">
                            <span style="color:${color}; font-weight:600;">${planLabel}</span>
                            <span style="color:#fff; font-size:1.2rem; font-weight:700;">${p.count} usu√°rios</span>
                        </div>`;
                    });
                    distDiv.innerHTML = distHtml || '<p style="color:#555;">Nenhum dado.</p>';

                    // Recent Registrations
                    const regDiv = document.getElementById('recent-registrations');
                    let regHtml = '<table class="admin-table"><thead><tr><th>Nome</th><th>Email</th><th>Plano</th><th>Data</th></tr></thead><tbody>';
                    data.recentRegistrations.forEach(r => {
                        regHtml += `<tr>
                            <td>${r.name}</td>
                            <td>${r.email}</td>
                            <td><span class="status-badge ${r.plan === 'black' ? 'status-black' : 'status-free'}">${r.plan}</span></td>
                            <td style="color:#666;">${new Date(r.created_at).toLocaleDateString('pt-BR')}</td>
                        </tr>`;
                    });
                    regHtml += '</tbody></table>';
                    regDiv.innerHTML = regHtml;

                } catch (e) { console.error(e); }
            }

            // LOAD & SAVE SETTINGS
            async function loadSettings() {
                try {
                    const res = await fetch('/api/admin/settings', { headers: { 'x-access-token': token } });
                    const data = await res.json();
                    if (data.maintenance_mode) document.getElementById('setting-maintenance').value = data.maintenance_mode;
                    if (data.global_announcement) document.getElementById('setting-announcement').value = data.global_announcement;
                } catch (e) { console.error(e); }
            }

            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const maint = document.getElementById('setting-maintenance').value;
                const ann = document.getElementById('setting-announcement').value;

                await fetch('/api/admin/settings', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                    body: JSON.stringify({ key: 'maintenance_mode', value: maint })
                });
                await fetch('/api/admin/settings', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                    body: JSON.stringify({ key: 'global_announcement', value: ann })
                });
                alert('Configura√ß√µes salvas!');
            });

            // GLOBAL ACTIONS
            window.changePlan = async (id, plan) => {
                if (!confirm(`Alterar plano para ${plan}?`)) return;
                await fetch('/api/admin/user/update-plan', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                    body: JSON.stringify({ userId: id, newPlan: plan })
                });
                loadUsers();
            };

            window.deleteUser = async (id) => {
                if (!confirm(`ATEN√á√ÉO: Isso excluir√° o usu√°rio ID ${id} permanentemente. Confirmar?`)) return;
                const res = await fetch(`/api/admin/user/${id}`, { method: 'DELETE', headers: { 'x-access-token': token } });
                if (res.ok) {
                    alert('Usu√°rio exclu√≠do.');
                    loadUsers();
                } else {
                    const d = await res.json();
                    alert(d.error || "Erro ao excluir.");
                }
            };

            loadStats();
            loadLogs();
        });
    </script>
</body>

</html>